name: ASI-T2 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-structure:
    runs-on: ubuntu-latest
    name: Validate Repository Structure
    outputs:
      simulation_id: ${{ steps.setup.outputs.simulation_id }}
      timestamp: ${{ steps.setup.outputs.timestamp }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup simulation tracking
      id: setup
      run: |
        # Generate simulation ID with timestamp and random suffix
        TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
        RANDOM_SUFFIX=$RANDOM
        SIMULATION_ID="sim_${TIMESTAMP}_${RANDOM_SUFFIX}"
        ISO_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "simulation_id=${SIMULATION_ID}" >> $GITHUB_OUTPUT
        echo "timestamp=${ISO_TIMESTAMP}" >> $GITHUB_OUTPUT
        
        echo "Simulation ID: ${SIMULATION_ID}"
        echo "Timestamp: ${ISO_TIMESTAMP}"
    
    - name: Verify ASI-T2 Structure
      run: |
        echo "Validating ASI-T2 repository structure..."
        
        # Check main directories exist
        test -d FIELDS || (echo "FIELDS directory missing" && exit 1)
        test -d ENVIRONMENTS || (echo "ENVIRONMENTS directory missing" && exit 1)
        test -d PRODUCTS || (echo "PRODUCTS directory missing" && exit 1)
        
        # Check key product directories
        test -d PRODUCTS/AMPEL360 || (echo "AMPEL360 directory missing" && exit 1)
        test -d PRODUCTS/INFRANET || (echo "INFRANET directory missing" && exit 1)
        
        echo "Structure validation completed successfully"
    
    - name: Validate Links
      run: |
        echo "Validating README.md structure and links..."
        test -f README.md || (echo "Main README.md missing" && exit 1)
        grep -q "ASI-T2" README.md || (echo "README.md missing ASI-T2 header" && exit 1)
        echo "Link validation completed"